<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Nutrizionista - YourWeek</title>
    <link rel="stylesheet" href="nutrizionistaPage.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="cookie-banner.css">
</head>

<body>
    <div class="back-to-login">
        <a href="loginPage.html">
            <i class="fas fa-arrow-left"></i>
            Torna al Login
        </a>
    </div>

    <header class="dashboard-header">
        <div class="logo">
            <h1>YourWeek</h1>
        </div>
        <div class="user-info">
            <div class="user-avatar">
                <i class="fas fa-user-md"></i>
            </div>
            <div class="user-details">
                <h3 id="userName">Dott. Marco Rossi</h3>
                <p>Nutrizionista Specialista</p>
            </div>
        </div>
    </header>

    <main class="dashboard-content">
        <div class="welcome-section">
            <h2>Benvenuto nella Tua Dashboard</h2>
            <p>Gestisci i tuoi pazienti, crea piani alimentari personalizzati e monitora i progressi con strumenti
                avanzati</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-number" id="activePatientsCount">0</div>
                <p>Pazienti Attivi</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div class="stat-number" id="newPatientsCount">0</div>
                <p>Nuovi Questo Mese</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-number">15</div>
                <p>Appuntamenti Settimana</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-number">92%</div>
                <p>Soddisfazione Pazienti</p>
            </div>
        </div>

        <!-- Sezione Codice Nutrizionista -->
        <div class="nutritionist-code-section">
            <h3 id="codeTitle">
                <i class="fas fa-id-card"></i>
                Il Tuo Codice Nutrizionista
            </h3>
            <p>Condividi questo codice con i tuoi pazienti per permettere loro di registrarsi e associarsi
                automaticamente a te</p>
            <div class="code-display-wrapper">
                <div id="nutritionistCode">Caricamento...</div>
            </div>
            <div>
                <button class="copy-btn" onclick="copyNutritionistCode()">
                    <i class="fas fa-copy"></i>
                    Copia Codice
                </button>
            </div>
        </div>

        <div class="features-grid">
            <div class="feature-card" onclick="location.href='gestionePazienti.html'">
                <div class="feature-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>Gestione Pazienti</h3>
                <p>Visualizza e gestisci tutti i tuoi pazienti, schede cliniche e storico progressi con strumenti
                    avanzati di monitoraggio</p>
                <span class="feature-badge">Modifica e Visualizza i tuoi pazienti</span>
            </div>

            <div class="feature-card" onclick="location.href='pianiDietetici.html'">
                <div class="feature-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <h3>Piani Dietetici</h3>
                <p>Crea e personalizza piani alimentari unici per ogni paziente con il nostro editor avanzato e database
                    ricette</p>
                <span class="feature-badge">Modifica e visualizza i piani alimentari dei tuoi pazienti</span>
            </div>

            <div class="feature-card" onclick="location.href='calendario.html'">
                <div class="feature-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <h3>Calendario Smart</h3>
                <p>Organizza appuntamenti, controlli e follow-up con sistema di promemoria automatico e integrazione
                    calendar</p>
                <span class="feature-badge">Visualizza i tuoi appuntamenti</span>
            </div>

            <div class="feature-card" onclick="location.href='messaggi.html'">
                <div class="feature-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h3>Comunicazioni</h3>
                <p>Messaggistica sicura con i pazienti, notifiche automatiche e sistema di promemoria per follow-up</p>
                <span class="feature-badge">Visualizza e manda i tuoi messaggi</span>
            </div>

            <div class="feature-card" onclick="location.href='report.html'">
                <div class="feature-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3>Analisi e Report</h3>
                <p>Dashboard avanzata con grafici interattivi, statistiche dettagliate e report personalizzabili</p>
                <span class="feature-badge">Analisi in Tempo Reale</span>
            </div>

            <div class="feature-card" onclick="location.href='areaPersonale.html'">
                <div class="feature-icon">
                    <i class="fas fa-folder"></i>
                </div>
                <h3>Area Personale</h3>
                <p>Gestisci i tuoi appunti, documenti e immagini necessari per lo svolgimento della tua attività</p>
                <span class="feature-badge">Appunti Personali</span>
            </div>

            <div class="feature-card" onclick="location.href='trovaCliente.html'">
                <div class="feature-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h3>Trova Clienti</h3>
                <p>Scopri i clienti che stanno cercando un nutrizionista nella tua provincia e contattali facilmente</p>
                <span class="feature-badge">Nuovi potenziali pazienti</span>
            </div>
        </div>

        <div class="recent-activity">
            <h3>Attività Recenti</h3>
            <ul class="activity-list">
                <li onclick="location.href='gestionePazienti.html'">
                    <div class="activity-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="activity-content">
                        <strong>Nuovo Paziente Registrato</strong>
                        <p>Maria Bianchi • Ieri alle 14:30 • Prima visita programmata</p>
                    </div>
                </li>
                <li onclick="location.href='pianiDietetici.html'">
                    <div class="activity-icon">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="activity-content">
                        <strong>Piano Dietetico Aggiornato</strong>
                        <p>Luca Verdi • Oggi alle 09:15 • Aggiunti nuovi alimenti</p>
                    </div>
                </li>
                <li onclick="location.href='calendario.html'">
                    <div class="activity-icon">
                        <i class="fas fa-calendar-plus"></i>
                    </div>
                    <div class="activity-content">
                        <strong>Nuovo Appuntamento</strong>
                        <p>Giulia Neri • Domani alle 11:00 • Controllo mensile</p>
                    </div>
                </li>
                <li onclick="location.href='messaggi.html'">
                    <div class="activity-icon">
                        <i class="fas fa-comment-medical"></i>
                    </div>
                    <div class="activity-content">
                        <strong>Messaggio Importante</strong>
                        <p>Paolo Russo • 2 ore fa • Richiesta modifica piano urgente</p>
                    </div>
                </li>
            </ul>
        </div>
    </main>

    <script>
        // Verifica autenticazione e carica dati utente
        async function checkAuthAndLoadUser() {
            try {
                const response = await fetch('../api/auth.php?action=check', {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success && result.authenticated) {
                    // Aggiorna il nome utente nell'header con titolo "Dott."
                    if (result.user.name) {
                        const fullName = result.user.name;
                        document.getElementById('userName').textContent = `Dott. ${fullName}`;
                    }

                    // Carica il codice nutrizionista
                    loadNutritionistCode();
                } else {
                    // Se non autenticato, reindirizza al login
                    alert('Sessione scaduta. Effettua nuovamente il login.');
                    window.location.href = 'loginPage.html';
                }
            } catch (error) {
                console.error('Errore verifica autenticazione:', error);
            }
        }

        // Carica il codice nutrizionista
        async function loadNutritionistCode() {
            try {
                const response = await fetch('../api/patients.php?action=get_nutritionist_code', {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success && result.code) {
                    document.getElementById('nutritionistCode').textContent = result.code;
                } else {
                    document.getElementById('nutritionistCode').textContent = 'Errore caricamento';
                    console.error('Errore caricamento codice:', result.error);
                }
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('nutritionistCode').textContent = 'Errore caricamento';
            }
        }

        // Copia il codice nutrizionista negli appunti
        function copyNutritionistCode() {
            const codeElement = document.getElementById('nutritionistCode');
            const code = codeElement.textContent;

            if (code && code !== 'Caricamento...' && code !== 'Errore caricamento') {
                navigator.clipboard.writeText(code).then(() => {
                    // Feedback visivo
                    const originalText = codeElement.textContent;
                    codeElement.textContent = '✓ Copiato!';
                    codeElement.style.color = '#fff';

                    setTimeout(() => {
                        codeElement.textContent = originalText;
                        codeElement.style.color = '';
                    }, 2000);
                }).catch(err => {
                    console.error('Errore copia:', err);
                    alert('Errore durante la copia del codice');
                });
            }
        }

        // Funzione per calcolare i pazienti nuovi del mese corrente
        function calculateNewPatientsThisMonth() {
            const patients = JSON.parse(localStorage.getItem('patients')) || [];
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let newPatientsCount = 0;

            patients.forEach(patient => {
                // Se il paziente ha una data di registrazione
                if (patient.registrationDate) {
                    const regDate = new Date(patient.registrationDate);
                    if (regDate.getMonth() === currentMonth && regDate.getFullYear() === currentYear) {
                        newPatientsCount++;
                    }
                }
            });

            return newPatientsCount;
        }

        // Animazioni al caricamento
        document.addEventListener('DOMContentLoaded', function () {
            // Carica i dati utente
            checkAuthAndLoadUser();

            const cards = document.querySelectorAll('.stat-card, .feature-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';

                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // Aggiorna i conteggi
            updateDashboardStats();
        });

        // Funzione per aggiornare tutte le statistiche
        function updateDashboardStats() {
            const patients = JSON.parse(localStorage.getItem('patients')) || [];

            // Aggiorna pazienti attivi
            const activePatients = patients.length;
            document.querySelector('.stat-number').textContent = activePatients;

            // Aggiorna pazienti nuovi del mese
            const newPatients = calculateNewPatientsThisMonth();
            document.getElementById('newPatientsCount').textContent = newPatients;

            // Aggiorna badge nelle feature cards
            document.querySelectorAll('.feature-badge')[0].textContent = `${activePatients} Pazienti`;
        }

        // Funzione per aggiornare il conteggio pazienti (chiamata da altre pagine)
        function updatePatientCount(count) {
            updateDashboardStats();
        }

        // Carica i dati all'avvio
        updateDashboardStats();
    </script>
    <script src="cookie-banner.js"></script>
</body>

</html>