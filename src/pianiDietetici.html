<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Piani Dietetici - YourWeek</title>
    <link rel="stylesheet" href="pianiDietetici.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<base target="_blank">
    <link rel="stylesheet" href="cookie-banner.css">
</head>

<body>
    <div class="back-button">
        <a href="nutrizionistaPage.html">
            <i class="fas fa-arrow-left"></i>
            Torna alla Dashboard
        </a>
    </div>

    <header class="dashboard-header">
        <div class="logo">
            <h1>yourweek</h1>
        </div>
        <div class="user-info">
            <h3>Gestione Piani</h3>
        </div>
    </header>

    <div class="container">
        <div class="page-title">
            <h2>Gestione Piani Alimentari</h2>
            <p>Assegna e gestisci i piani dietetici dei tuoi pazienti</p>
        </div>

        <div class="patients-grid" id="patientsGrid">
            <!-- I pazienti verranno generati dinamicamente con JavaScript -->
        </div>
    </div>

    <!-- Modal per il piano dietetico -->
    <div class="modal" id="dietModal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">&times;</button>
            <div id="modalContent">
                <!-- Il contenuto del modal verrà popolato dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal per l'upload del file o inserimento manuale -->
    <div class="modal" id="addPlanModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeAddPlanModal()">&times;</button>
            <h2 style="text-align: center; margin-bottom: 30px; color: #064e3b; font-size: 2rem;">
                <i class="fas fa-utensils"></i> Assegna Piano Dietetico
            </h2>

            <div id="selectedPatientInfo" style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 15px;">
            </div>

            <!-- Toggle per scegliere il metodo di inserimento -->
            <div class="input-method-toggle">
                <button class="toggle-btn active" id="btnManual" onclick="setInputMethod('manual')">
                    <i class="fas fa-keyboard"></i> Inserimento Manuale
                </button>
                <button class="toggle-btn" id="btnFile" onclick="setInputMethod('file')">
                    <i class="fas fa-file-upload"></i> Carica File
                </button>
            </div>

            <!-- Sezione Inserimento Manuale -->
            <div id="manualInputSection">
                <div class="weekly-plan">
                    <div class="week-title">
                        <i class="fas fa-calendar-week"></i> Piano Settimanale
                    </div>
                    <table class="meal-table">
                        <thead>
                            <tr>
                                <th>Giorno</th>
                                <th><i class="fas fa-coffee"></i> Colazione</th>
                                <th><i class="fas fa-utensils"></i> Pranzo</th>
                                <th><i class="fas fa-moon"></i> Cena</th>
                                <th><i class="fas fa-apple-alt"></i> Spuntini</th>
                            </tr>
                        </thead>
                        <tbody id="manualMealTableBody">
                            <!-- Generato dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sezione Upload File -->
            <div id="fileInputSection" style="display: none;">
                <div class="upload-section">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Carica Piano Dietetico</h3>
                    <p>Carica un file PDF, Word o Excel con il piano alimentare del paziente</p>

                    <div class="upload-area" onclick="document.getElementById('planFileInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Clicca qui o trascina il file</p>
                        <small style="color: #6b7280;">PDF, DOC, DOCX, XLS, XLSX (max 10MB)</small>
                    </div>
                    <input type="file" id="planFileInput" class="file-input" accept=".pdf,.doc,.docx,.xls,.xlsx" onchange="handleFileSelect(event)">

                    <div id="filePreview" style="display: none;">
                        <div class="file-preview">
                            <i class="fas fa-file-alt"></i>
                            <div class="file-info">
                                <div class="file-name" id="fileName">nome_file.pdf</div>
                                <div class="file-size" id="fileSize">2.5 MB</div>
                            </div>
                            <button class="remove-file" onclick="removeFile()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeAddPlanModal()">Annulla</button>
                <button class="save-btn" onclick="saveDietPlan()">
                    <i class="fas fa-save"></i> Salva Piano
                </button>
            </div>
        </div>
    </div>

    <script>
        let patients = [];
        let currentEditingPatient = null;

        // Funzione per caricare i pazienti dall'API
        async function loadPatients() {
            try {
                const response = await fetch('../api/patients.php?action=get_my_patients', {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    patients = result.patients.map(p => ({
                        id: p.id,
                        name: p.first_name,
                        surname: p.last_name,
                        description: p.focus_area || "Piano alimentare personalizzato",
                        avatar: (p.first_name[0] + p.last_name[0]).toUpperCase(),
                        dietStats: {
                            calorie: p.target_calories ? p.target_calories + " kcal" : "Da definire",
                            proteine: p.target_protein ? p.target_protein + "g" : "Da definire",
                            pasti: p.meals_per_day || "5"
                        },
                        mealPlan: {
                            week: "Settimana Corrente",
                            days: {
                                lunedi: { colazione: "", pranzo: "", cena: "", spuntini: "" },
                                martedi: { colazione: "", pranzo: "", cena: "", spuntini: "" },
                                mercoledi: { colazione: "", pranzo: "", cena: "", spuntini: "" },
                                giovedi: { colazione: "", pranzo: "", cena: "", spuntini: "" },
                                venerdi: { colazione: "", pranzo: "", cena: "", spuntini: "" },
                                sabato: { colazione: "", pranzo: "", cena: "", spuntini: "" },
                                domenica: { colazione: "", pranzo: "", cena: "", spuntini: "" }
                            }
                        }
                    }));
                    renderPatients();
                } else {
                    console.error('Errore caricamento pazienti:', result.error);
                }
            } catch (error) {
                console.error('Errore durante il caricamento:', error);
            }
        }

        // Funzione per generare le card dei pazienti
        function renderPatients() {
            const grid = document.getElementById('patientsGrid');
            grid.innerHTML = '';

            if (patients.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #065f46; grid-column: 1 / -1; font-size: 1.2rem; padding: 40px;">Nessun paziente assegnato.</p>';
                return;
            }

            patients.forEach(patient => {
                const card = document.createElement('div');
                card.className = 'patient-card';

                card.innerHTML = `
                    <div class="patient-header">
                        <div class="patient-avatar">${patient.avatar}</div>
                        <div class="patient-info">
                            <h3>${patient.name} ${patient.surname}</h3>
                            <div class="description">${patient.description}</div>
                        </div>
                    </div>
                    <div class="patient-stats">
                        <div class="stat">
                            <div class="value">${patient.dietStats.calorie}</div>
                            <div class="label">Calorie</div>
                        </div>
                        <div class="stat">
                            <div class="value">${patient.dietStats.proteine}</div>
                            <div class="label">Proteine</div>
                        </div>
                        <div class="stat">
                            <div class="value">${patient.dietStats.pasti}</div>
                            <div class="label">Pasti/Giorno</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(16, 185, 129, 0.1); display: flex; gap: 10px;">
                        <button class="save-btn" style="flex: 1; padding: 10px; font-size: 0.9rem;" onclick="event.stopPropagation(); openAddPlanModal(patients.find(p => p.id === ${patient.id}))">
                            <i class="fas fa-plus"></i> Assegna Piano
                        </button>
                        <button class="cancel-btn" style="flex: 1; padding: 10px; font-size: 0.9rem;" onclick="event.stopPropagation(); openDietModal(patients.find(p => p.id === ${patient.id}))">
                            <i class="fas fa-eye"></i> Visualizza
                        </button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Funzione per aprire il modal con il piano dietetico
        async function openDietModal(patient) {
            currentEditingPatient = patient;

            const modal = document.getElementById('dietModal');
            const modalContent = document.getElementById('modalContent');

            // Carica i dati aggiornati dal database
            try {
                const response = await fetch(`../api/diet_plans.php?action=get_patient_plan&patient_id=${patient.id}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success && result.hasPlan) {
                    // Se è un file, mostra il file
                    if (result.file && result.file.file_path) {
                        const fileExt = result.file.file_type.toLowerCase();
                        const isPdf = fileExt === 'pdf';
                        const isWord = ['doc', 'docx'].includes(fileExt);
                        
                        let fileViewer = '';
                        if (isPdf) {
                            fileViewer = `<iframe src="../${result.file.file_path}" 
                                style="width: 100%; height: 600px; border: 2px solid #10b981; border-radius: 10px;"
                                frameborder="0">
                            </iframe>`;
                        } else if (isWord) {
                            // Per file Word, mostra un link per scaricare/aprire
                            fileViewer = `
                                <div style="padding: 40px; background: #f0fdf4; border-radius: 10px; border: 2px dashed #10b981;">
                                    <i class="fas fa-file-word" style="font-size: 4rem; color: #064e3b; margin-bottom: 20px;"></i>
                                    <h3 style="color: #064e3b; margin-bottom: 10px;">${result.file.file_name}</h3>
                                    <p style="color: #065f46; margin-bottom: 20px;">File Word - ${formatFileSize(result.file.file_size)}</p>
                                    <p style="color: #6b7280; font-size: 0.9rem;">I file Word devono essere scaricati e aperti con Microsoft Word o un editor compatibile.</p>
                                </div>
                            `;
                        } else {
                            fileViewer = `
                                <div style="padding: 40px; background: #f0fdf4; border-radius: 10px; border: 2px dashed #10b981;">
                                    <i class="fas fa-file-alt" style="font-size: 4rem; color: #064e3b; margin-bottom: 20px;"></i>
                                    <h3 style="color: #064e3b; margin-bottom: 10px;">${result.file.file_name}</h3>
                                    <p style="color: #065f46; margin-bottom: 20px;">${formatFileSize(result.file.file_size)}</p>
                                </div>
                            `;
                        }
                        
                        modalContent.innerHTML = `
                            <div class="patient-detail-header">
                                <div class="patient-detail-avatar">${patient.avatar}</div>
                                <div>
                                    <h2>${patient.name} ${patient.surname}</h2>
                                    <p>${patient.description}</p>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 40px;">
                                <h3 style="margin-bottom: 20px; color: #064e3b;">
                                    <i class="fas fa-file-${isPdf ? 'pdf' : isWord ? 'word' : 'alt'}"></i> Piano Dietetico - File
                                </h3>
                                ${fileViewer}
                                <div style="margin-top: 20px;">
                                    <a href="../${result.file.file_path}" ${isPdf ? '' : 'download'} target="_blank" class="save-btn" style="display: inline-block; text-decoration: none; margin-right: 10px;">
                                        <i class="fas fa-${isPdf ? 'eye' : 'download'}"></i> ${isPdf ? 'Visualizza' : 'Scarica'} File
                                    </a>
                                </div>
                            </div>
                        `;
                    } else if (result.meals && Object.keys(result.meals).length > 0) {
                        // Se ci sono pasti, mostra la tabella
                        const days = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                        const convertedMeals = {};
                        days.forEach(day => {
                            convertedMeals[day] = {
                                colazione: result.meals[day]?.['colazione'] || '',
                                pranzo: result.meals[day]?.['pranzo'] || '',
                                cena: result.meals[day]?.['cena'] || '',
                                spuntini: [
                                    result.meals[day]?.['spuntino-mattina'],
                                    result.meals[day]?.['spuntino-pomeriggio'],
                                    result.meals[day]?.['spuntino-sera']
                                ].filter(Boolean).join('\n')
                            };
                        });

                        // Aggiorna i dati del paziente in memoria
                        patient.mealPlan.days = convertedMeals;
                        patient.mealPlan.planName = result.plan.plan_name;
                        // Salva l'ID del piano per l'aggiornamento
                        patient.currentPlanId = result.plan.id;

                        modalContent.innerHTML = `
                            <div class="patient-detail-header">
                                <div class="patient-detail-avatar">${patient.avatar}</div>
                                <div>
                                    <h2>${patient.name} ${patient.surname}</h2>
                                    <p>${patient.description}</p>
                                </div>
                            </div>

                            <div class="weekly-plan">
                                <div class="week-title">
                                    <i class="fas fa-calendar-week"></i> ${result.plan.plan_name || patient.mealPlan.week}
                                </div>

                                <table class="meal-table">
                                    <thead>
                                        <tr>
                                            <th>Giorno</th>
                                            <th><i class="fas fa-coffee"></i> Colazione</th>
                                            <th><i class="fas fa-utensils"></i> Pranzo</th>
                                            <th><i class="fas fa-moon"></i> Cena</th>
                                            <th><i class="fas fa-apple-alt"></i> Spuntini</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${generateMealRows(convertedMeals)}
                                    </tbody>
                                </table>
                            </div>

                            <div class="modal-actions">
                                <button class="save-btn" onclick="saveMealPlan()">
                                    <i class="fas fa-save"></i> Salva Modifiche
                                </button>
                            </div>
                        `;

                        // Aggiungi event listeners per l'editing
                        setTimeout(() => {
                            addEditListeners();
                        }, 100);
                    } else {
                        // Nessun piano trovato
                        modalContent.innerHTML = `
                            <div class="patient-detail-header">
                                <div class="patient-detail-avatar">${patient.avatar}</div>
                                <div>
                                    <h2>${patient.name} ${patient.surname}</h2>
                                    <p>${patient.description}</p>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 40px;">
                                <i class="fas fa-info-circle" style="font-size: 3rem; color: #6b7280; margin-bottom: 20px;"></i>
                                <h3 style="color: #6b7280;">Nessun piano dietetico assegnato</h3>
                                <p style="color: #9ca3af;">Assegna un piano dietetico a questo paziente per visualizzarlo qui.</p>
                            </div>
                        `;
                    }
                } else {
                    // Nessun piano trovato
                    modalContent.innerHTML = `
                        <div class="patient-detail-header">
                            <div class="patient-detail-avatar">${patient.avatar}</div>
                            <div>
                                <h2>${patient.name} ${patient.surname}</h2>
                                <p>${patient.description}</p>
                            </div>
                        </div>
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-info-circle" style="font-size: 3rem; color: #6b7280; margin-bottom: 20px;"></i>
                            <h3 style="color: #6b7280;">Nessun piano dietetico assegnato</h3>
                            <p style="color: #9ca3af;">Assegna un piano dietetico a questo paziente per visualizzarlo qui.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Errore caricamento piano:', error);
                modalContent.innerHTML = `
                    <div class="patient-detail-header">
                        <div class="patient-detail-avatar">${patient.avatar}</div>
                        <div>
                            <h2>${patient.name} ${patient.surname}</h2>
                            <p>${patient.description}</p>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444; margin-bottom: 20px;"></i>
                        <h3 style="color: #ef4444;">Errore nel caricamento</h3>
                        <p style="color: #9ca3af;">Si è verificato un errore durante il caricamento del piano dietetico.</p>
                    </div>
                `;
            }

            modal.style.display = 'block';
        }

        // Genera le righe della tabella pasti
        function generateMealRows(days) {
            const dayNames = {
                lunedi: 'Lunedì',
                martedi: 'Martedì',
                mercoledi: 'Mercoledì',
                giovedi: 'Giovedì',
                venerdi: 'Venerdì',
                sabato: 'Sabato',
                domenica: 'Domenica'
            };

            // Funzione helper per formattare il testo (converte \n in <br>)
            function formatText(text) {
                if (!text || text.trim() === '') return '<div class="empty-meal">Clicca per aggiungere</div>';
                return text.replace(/\n/g, '<br>');
            }

            // Funzione helper per escape HTML nel textarea
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            let html = '';
            for (const [dayKey, dayName] of Object.entries(dayNames)) {
                const meals = days[dayKey] || {};
                html += `
                    <tr>
                        <td><strong>${dayName}</strong></td>
                        <td>
                            <div class="meal-content" data-day="${dayKey}" data-meal="colazione">
                                <span class="meal-text">${formatText(meals.colazione)}</span>
                                <textarea class="meal-edit" style="display: none;">${escapeHtml(meals.colazione || '')}</textarea>
                            </div>
                        </td>
                        <td>
                            <div class="meal-content" data-day="${dayKey}" data-meal="pranzo">
                                <span class="meal-text">${formatText(meals.pranzo)}</span>
                                <textarea class="meal-edit" style="display: none;">${escapeHtml(meals.pranzo || '')}</textarea>
                            </div>
                        </td>
                        <td>
                            <div class="meal-content" data-day="${dayKey}" data-meal="cena">
                                <span class="meal-text">${formatText(meals.cena)}</span>
                                <textarea class="meal-edit" style="display: none;">${escapeHtml(meals.cena || '')}</textarea>
                            </div>
                        </td>
                        <td>
                            <div class="meal-content" data-day="${dayKey}" data-meal="spuntini">
                                <span class="meal-text">${formatText(meals.spuntini)}</span>
                                <textarea class="meal-edit" style="display: none;">${escapeHtml(meals.spuntini || '')}</textarea>
                            </div>
                        </td>
                    </tr>
                `;
            }
            return html;
        }

        // Aggiungi event listeners per l'editing
        function addEditListeners() {
            const mealContents = document.querySelectorAll('.meal-content');

            mealContents.forEach(content => {
                content.addEventListener('click', function (e) {
                    if (e.target.classList.contains('meal-edit')) return;

                    const textElement = this.querySelector('.meal-text');
                    const editElement = this.querySelector('.meal-edit');

                    // Entra in modalità editing
                    this.classList.add('editing');
                    textElement.style.display = 'none';
                    editElement.style.display = 'block';
                    editElement.focus();

                    // Salva quando perde il focus
                    editElement.addEventListener('blur', function () {
                        saveMealEdit(this);
                    });

                    // Salva con Enter (senza shift)
                    editElement.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.blur();
                        }
                    });
                });
            });
        }

        // Salva la modifica di un pasto
        function saveMealEdit(textarea) {
            const contentDiv = textarea.parentElement;
            const textElement = contentDiv.querySelector('.meal-text');
            const day = contentDiv.getAttribute('data-day');
            const meal = contentDiv.getAttribute('data-meal');
            const newValue = textarea.value.trim();

            // Esci dalla modalità editing
            contentDiv.classList.remove('editing');
            textarea.style.display = 'none';
            textElement.style.display = 'block';

            if (newValue) {
                textElement.innerHTML = newValue.replace(/\n/g, '<br>');
                // Aggiorna i dati del paziente
                if (currentEditingPatient && currentEditingPatient.mealPlan.days[day]) {
                    currentEditingPatient.mealPlan.days[day][meal] = newValue;
                }
            } else {
                textElement.innerHTML = '<div class="empty-meal">Clicca per aggiungere</div>';
                if (currentEditingPatient && currentEditingPatient.mealPlan.days[day]) {
                    delete currentEditingPatient.mealPlan.days[day][meal];
                }
            }
        }

        // Salva l'intero piano alimentare
        async function saveMealPlan() {
            if (!currentEditingPatient) return;

            // Raccogli i dati dalla tabella
            const mealPlan = {};
            const days = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
            const meals = ['colazione', 'pranzo', 'cena', 'spuntini'];

            days.forEach(day => {
                mealPlan[day] = {};
                meals.forEach(meal => {
                    const mealContent = document.querySelector(`[data-day="${day}"][data-meal="${meal}"]`);
                    if (mealContent) {
                        const textElement = mealContent.querySelector('.meal-text');
                        const editElement = mealContent.querySelector('.meal-edit');
                        // Prendi il valore dal textarea se è in editing, altrimenti dal testo
                        let value = '';
                        if (editElement && editElement.style.display !== 'none') {
                            value = editElement.value.trim();
                        } else if (textElement) {
                            value = textElement.textContent.trim();
                            // Rimuovi il testo "Clicca per aggiungere" se presente
                            if (value === 'Clicca per aggiungere') {
                                value = '';
                            }
                        }
                        if (value) {
                            mealPlan[day][meal] = value.replace(/<br>/g, '\n');
                        }
                    }
                });
            });

            // Usa il nome del piano esistente se disponibile, altrimenti crea uno nuovo
            const planName = currentEditingPatient.mealPlan?.planName || 
                            'Piano Dietetico - ' + new Date().toLocaleDateString('it-IT');

            const formData = new FormData();
            formData.append('patient_id', currentEditingPatient.id);
            formData.append('input_method', 'manual');
            formData.append('plan_name', planName);
            formData.append('meal_plan', JSON.stringify(mealPlan));

            try {
                const response = await fetch('../api/diet_plans.php?action=save_plan', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Piano alimentare aggiornato con successo!');
                    closeModal();
                    loadPatients(); // Ricarica la lista
                } else {
                    alert('Errore: ' + (result.error || 'Errore durante il salvataggio'));
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore durante il salvataggio del piano');
            }
        }

        // Funzione per mostrare notifiche
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4db8ff, #2d4a5c);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(77, 184, 255, 0.4);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Chiudi il modal
        function closeModal() {
            document.getElementById('dietModal').style.display = 'none';
        }

        document.getElementById('closeModal').onclick = closeModal;

        // Chiudi il modal cliccando fuori
        window.onclick = function (event) {
            const modal = document.getElementById('dietModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Variabili per la gestione del piano
        let currentInputMethod = 'manual';
        let selectedFile = null;
        let currentPatientForPlan = null;

        // Funzione per impostare il metodo di inserimento
        function setInputMethod(method) {
            currentInputMethod = method;

            // Aggiorna i bottoni
            document.getElementById('btnManual').classList.toggle('active', method === 'manual');
            document.getElementById('btnFile').classList.toggle('active', method === 'file');

            // Mostra/nascondi le sezioni
            document.getElementById('manualInputSection').style.display = method === 'manual' ? 'block' : 'none';
            document.getElementById('fileInputSection').style.display = method === 'file' ? 'block' : 'none';
        }

        // Funzione per gestire la selezione del file
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('filePreview').style.display = 'block';
            }
        }

        // Formatta la dimensione del file
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Rimuovi il file selezionato
        function removeFile() {
            selectedFile = null;
            document.getElementById('planFileInput').value = '';
            document.getElementById('filePreview').style.display = 'none';
        }

        // Apre il modal per aggiungere un piano dietetico
        async function openAddPlanModal(patient) {
            currentPatientForPlan = patient;

            // Mostra info paziente
            const info = document.getElementById('selectedPatientInfo');
            info.innerHTML = `
                <h3 style="color: #064e3b; margin-bottom: 10px; font-size: 1.5rem;">${patient.name} ${patient.surname}</h3>
                <p style="color: #065f46; font-size: 1.1rem;">${patient.description}</p>
            `;

            // Reset stato
            setInputMethod('manual');
            removeFile();

            // Carica il piano esistente se presente
            try {
                const response = await fetch(`../api/diet_plans.php?action=get_patient_plan&patient_id=${patient.id}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();

                let existingMealPlan = null;
                if (result.success && result.hasPlan && result.meals) {
                    // Converti i pasti dal formato database al formato frontend
                    const days = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                    existingMealPlan = {};
                    days.forEach(day => {
                        if (result.meals[day]) {
                            existingMealPlan[day] = {
                                colazione: result.meals[day]['colazione'] || '',
                                pranzo: result.meals[day]['pranzo'] || '',
                                cena: result.meals[day]['cena'] || '',
                                spuntini: [
                                    result.meals[day]['spuntino-mattina'],
                                    result.meals[day]['spuntino-pomeriggio'],
                                    result.meals[day]['spuntino-sera']
                                ].filter(Boolean).join('\n')
                            };
                        }
                    });
                }

                // Genera la tabella per l'inserimento manuale con i dati esistenti
                generateManualMealTable(existingMealPlan);

            } catch (error) {
                console.error('Errore caricamento piano esistente:', error);
                // Se c'è un errore, genera la tabella vuota
                generateManualMealTable();
            }

            // Mostra il modal
            document.getElementById('addPlanModal').style.display = 'block';
        }

        // Genera la tabella per l'inserimento manuale
        function generateManualMealTable(existingMealPlan = null) {
            const tbody = document.getElementById('manualMealTableBody');
            const dayNames = {
                lunedi: 'Lunedì',
                martedi: 'Martedì',
                mercoledi: 'Mercoledì',
                giovedi: 'Giovedì',
                venerdi: 'Venerdì',
                sabato: 'Sabato',
                domenica: 'Domenica'
            };

            // Funzione helper per escape HTML nel textarea
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            let html = '';
            for (const [dayKey, dayName] of Object.entries(dayNames)) {
                const meals = existingMealPlan && existingMealPlan[dayKey] ? existingMealPlan[dayKey] : {};
                html += `
                    <tr>
                        <td><strong>${dayName}</strong></td>
                        <td>
                            <textarea class="meal-edit" id="${dayKey}_colazione" 
                                placeholder="Clicca per aggiungere" rows="2">${escapeHtml(meals.colazione || '')}</textarea>
                        </td>
                        <td>
                            <textarea class="meal-edit" id="${dayKey}_pranzo" 
                                placeholder="Clicca per aggiungere" rows="2">${escapeHtml(meals.pranzo || '')}</textarea>
                        </td>
                        <td>
                            <textarea class="meal-edit" id="${dayKey}_cena" 
                                placeholder="Clicca per aggiungere" rows="2">${escapeHtml(meals.cena || '')}</textarea>
                        </td>
                        <td>
                            <textarea class="meal-edit" id="${dayKey}_spuntini" 
                                placeholder="Clicca per aggiungere" rows="2">${escapeHtml(meals.spuntini || '')}</textarea>
                        </td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        // Chiudi il modal per aggiungere piano
        function closeAddPlanModal() {
            document.getElementById('addPlanModal').style.display = 'none';
            currentPatientForPlan = null;
        }

        // Salva il piano dietetico
        async function saveDietPlan() {
            if (!currentPatientForPlan) return;

            const formData = new FormData();
            formData.append('patient_id', currentPatientForPlan.id);
            formData.append('input_method', currentInputMethod);
            formData.append('plan_name', 'Piano Dietetico - ' + new Date().toLocaleDateString('it-IT'));

            if (currentInputMethod === 'file' && selectedFile) {
                formData.append('plan_file', selectedFile);
            } else if (currentInputMethod === 'manual') {
                // Raccogli i dati dalla tabella
                const mealPlan = {};
                const days = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                const meals = ['colazione', 'pranzo', 'cena', 'spuntini'];

                days.forEach(day => {
                    mealPlan[day] = {};
                    meals.forEach(meal => {
                        const value = document.getElementById(`${day}_${meal}`).value.trim();
                        if (value) {
                            mealPlan[day][meal] = value;
                        }
                    });
                });

                formData.append('meal_plan', JSON.stringify(mealPlan));
            }

            try {
                const response = await fetch('../api/diet_plans.php?action=save_plan', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Piano dietetico salvato con successo!');
                    closeAddPlanModal();
                    loadPatients(); // Ricarica la lista
                } else {
                    alert('Errore: ' + (result.error || 'Errore durante il salvataggio'));
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore durante il salvataggio del piano');
            }
        }

        // Inizializza la pagina
        document.addEventListener('DOMContentLoaded', loadPatients);
    </script>

    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
    <script src="cookie-banner.js"></script>
</body>

</html>