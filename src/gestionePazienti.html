<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Pazienti - YourWeek</title>
    <link rel="stylesheet" href="gestionePazienti.css">
</head>
<body>
    <div class="back-button">
        <a href="nutrizionistaPage.html">
            <i class="fas fa-arrow-left"></i>
            Torna alla Dashboard
        </a>
    </div>

    <header class="dashboard-header">
        <div class="logo">
            <h1>yourweek</h1>
        </div>
        <div class="user-info">
            <h3>Gestione Pazienti</h3>
        </div>
    </header>

    <div class="container">
        <div class="page-title">
            <h2>I Tuoi Pazienti</h2>
            <p>Gestisci e monitora i progressi dei tuoi pazienti</p>
        </div>

        <button class="add-patient-btn" onclick="openAddPatientModal()">
            <i class="fas fa-plus"></i>
            Aggiungi Nuovo Paziente
        </button>

        <div class="patients-grid" id="patientsGrid"></div>
    </div>

    <!-- Modal dettagli paziente -->
    <div class="modal" id="patientModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Modal aggiungi paziente -->
    <div class="modal" id="addPatientModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeAddPatientModal()">&times;</button>
            <h2 style="text-align: center; margin-bottom: 30px; color: #2d4a5c; font-size: 2rem;">Aggiungi Nuovo Paziente</h2>
            <div class="patient-details-grid">
                <div class="detail-group">
                    <h4>Nome</h4>
                    <input type="text" class="input-field" id="newPatientName" placeholder="Inserisci nome">
                </div>
                <div class="detail-group">
                    <h4>Cognome</h4>
                    <input type="text" class="input-field" id="newPatientSurname" placeholder="Inserisci cognome">
                </div>
                <div class="detail-group">
                    <h4>Data di Nascita</h4>
                    <input type="date" class="input-field" id="newPatientBirthDate">
                </div>
                <div class="detail-group">
                    <h4>Altezza (cm)</h4>
                    <input type="number" class="input-field" id="newPatientHeight" placeholder="Es. 175">
                </div>
                <div class="detail-group">
                    <h4>Peso Iniziale (kg)</h4>
                    <input type="number" class="input-field" id="newPatientWeight" placeholder="Es. 70">
                </div>
                <div class="detail-group">
                    <h4>Massa Grassa Iniziale (%)</h4>
                    <input type="number" class="input-field" id="newPatientBodyFat" placeholder="Es. 22">
                </div>
                <div class="detail-group">
                    <h4>Massa Muscolare Iniziale (%)</h4>
                    <input type="number" class="input-field" id="newPatientMuscleMass" placeholder="Es. 38">
                </div>
                <div class="detail-group">
                    <h4>Descrizione/Obiettivo</h4>
                    <input type="text" class="input-field" id="newPatientDescription" placeholder="Es. Obiettivo: Dimagrimento">
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeAddPatientModal()">Annulla</button>
                <button class="save-btn" onclick="addNewPatient()">Salva Paziente</button>
            </div>
        </div>
    </div>

    <script>
        let patients = JSON.parse(localStorage.getItem('patients')) || [
            {
                id: 1,
                name: "Mario",
                surname: "Rossi",
                description: "Obiettivo: Dimagrimento - Iniziato 3 mesi fa",
                avatar: "MR",
                weight: "78 kg",
                height: "175 cm",
                birthDate: "15/03/1985",
                bodyFat: "22%",
                muscleMass: "38%",
                nextVisit: "20/12/2024",
                registrationDate: new Date(2024, 8, 15).toISOString(), // Settembre 2024
                weightHistory: [
                    { month: 'Gen', weight: 85 },
                    { month: 'Feb', weight: 82 },
                    { month: 'Mar', weight: 80 },
                    { month: 'Apr', weight: 78 }
                ],
                bodyFatHistory: [
                    { month: 'Gen', bodyFat: 28 },
                    { month: 'Feb', bodyFat: 25 },
                    { month: 'Mar', bodyFat: 23 },
                    { month: 'Apr', bodyFat: 22 }
                ]
            },
            {
                id: 2,
                name: "Laura",
                surname: "Bianchi",
                description: "Obiettivo: Aumento massa muscolare - Atleta",
                avatar: "LB",
                weight: "65 kg",
                height: "168 cm",
                birthDate: "22/07/1992",
                bodyFat: "18%",
                muscleMass: "42%",
                nextVisit: "18/12/2024",
                registrationDate: new Date(2024, 10, 5).toISOString(), // Novembre 2024
                weightHistory: [
                    { month: 'Gen', weight: 62 },
                    { month: 'Feb', weight: 63 },
                    { month: 'Mar', weight: 64 },
                    { month: 'Apr', weight: 65 }
                ],
                bodyFatHistory: [
                    { month: 'Gen', bodyFat: 20 },
                    { month: 'Feb', bodyFat: 19 },
                    { month: 'Mar', bodyFat: 18.5 },
                    { month: 'Apr', bodyFat: 18 }
                ]
            }
        ];

        let currentEditingPatient = null;
        let isEditing = false;

        function renderPatients() {
            const grid = document.getElementById('patientsGrid');
            grid.innerHTML = '';

            patients.forEach(patient => {
                const card = document.createElement('div');
                card.className = 'patient-card';
                card.onclick = () => openPatientModal(patient);
                
                card.innerHTML = `
                    <div class="patient-header">
                        <div class="patient-avatar">${patient.avatar}</div>
                        <div class="patient-info">
                            <h3>${patient.name} ${patient.surname}</h3>
                            <div class="description">${patient.description}</div>
                        </div>
                    </div>
                    <div class="patient-stats">
                        <div class="stat">
                            <div class="value">${patient.weight}</div>
                            <div class="label">Peso</div>
                        </div>
                        <div class="stat">
                            <div class="value">${patient.bodyFat}</div>
                            <div class="label">Massa Grassa</div>
                        </div>
                        <div class="stat">
                            <div class="value">${patient.nextVisit}</div>
                            <div class="label">Prossima Visita</div>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function openPatientModal(patient) {
            currentEditingPatient = patient;
            const modal = document.getElementById('patientModal');
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = `
                <div class="patient-detail-header">
                    <div class="patient-detail-avatar">${patient.avatar}</div>
                    <div>
                        <h2>${patient.name} ${patient.surname}</h2>
                        <p>${patient.description}</p>
                    </div>
                </div>

                <div class="current-stats">
                    <h4>Ultime Misurazioni</h4>
                    <div class="stats-display">
                        <div class="stat-item">
                            <div class="value">${patient.weight}</div>
                            <div class="label">Peso Attuale</div>
                        </div>
                        <div class="stat-item">
                            <div class="value">${patient.bodyFat}</div>
                            <div class="label">Massa Grassa</div>
                        </div>
                    </div>
                </div>

                <div class="patient-details-grid">
                    <div class="detail-group">
                        <h4>Altezza</h4>
                        <div class="detail-value">${patient.height}</div>
                        <button class="edit-btn" onclick="enableEditing('height')">Modifica</button>
                        <input type="text" class="input-field" id="editHeight" value="${patient.height}" style="display: none;">
                    </div>
                    <div class="detail-group">
                        <h4>Data di Nascita</h4>
                        <div class="detail-value">${patient.birthDate}</div>
                    </div>
                    <div class="detail-group">
                        <h4>Massa Muscolare</h4>
                        <div class="detail-value">${patient.muscleMass}</div>
                    </div>
                    <div class="detail-group">
                        <h4>Prossima Visita</h4>
                        <div class="detail-value">${patient.nextVisit}</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Andamento del Peso</div>
                    <canvas id="weightChart"></canvas>
                </div>

                <div class="modal-actions" id="modalActions" style="display: none;">
                    <button class="cancel-btn" onclick="cancelEditing()">Annulla</button>
                    <button class="save-btn" onclick="savePatientData()">Salva Modifiche</button>
                </div>
            `;

            setTimeout(() => createWeightChart(patient), 100);
            modal.style.display = 'block';
        }

        function createWeightChart(patient) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: patient.weightHistory.map(item => item.month),
                    datasets: [{
                        label: 'Peso (kg)',
                        data: patient.weightHistory.map(item => item.weight),
                        borderColor: '#4db8ff',
                        backgroundColor: 'rgba(77, 184, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#2d4a5c' }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: '#e3f2fd' },
                            ticks: { color: '#2d4a5c' }
                        },
                        x: {
                            grid: { color: '#e3f2fd' },
                            ticks: { color: '#2d4a5c' }
                        }
                    }
                }
            });
        }

        function enableEditing(field) {
            isEditing = true;
            document.getElementById(`edit${field.charAt(0).toUpperCase() + field.slice(1)}`).style.display = 'block';
            document.querySelector(`[onclick="enableEditing('${field}')"]`).style.display = 'none';
            document.getElementById('modalActions').style.display = 'flex';
        }

        function savePatientData() {
            localStorage.setItem('patients', JSON.stringify(patients));
            renderPatients();
            closeModal();
            alert('Dati aggiornati con successo!');
        }

        function cancelEditing() {
            openPatientModal(currentEditingPatient);
        }

        function openAddPatientModal() {
            document.getElementById('addPatientModal').style.display = 'block';
        }

        function closeAddPatientModal() {
            document.getElementById('addPatientModal').style.display = 'none';
        }

        function addNewPatient() {
            const name = document.getElementById('newPatientName').value;
            const surname = document.getElementById('newPatientSurname').value;
            
            if (!name || !surname) {
                alert('Inserisci almeno nome e cognome del paziente');
                return;
            }

            const newPatient = {
                id: patients.length + 1,
                name: name,
                surname: surname,
                description: document.getElementById('newPatientDescription').value || 'Nuovo paziente',
                avatar: `${name.charAt(0)}${surname.charAt(0)}`,
                weight: `${document.getElementById('newPatientWeight').value} kg`,
                height: `${document.getElementById('newPatientHeight').value} cm`,
                birthDate: new Date(document.getElementById('newPatientBirthDate').value).toLocaleDateString('it-IT'),
                bodyFat: `${document.getElementById('newPatientBodyFat').value}%`,
                muscleMass: `${document.getElementById('newPatientMuscleMass').value}%`,
                nextVisit: 'Da programmare',
                registrationDate: new Date().toISOString(), // Data di registrazione
                weightHistory: [],
                bodyFatHistory: []
            };

            patients.push(newPatient);
            localStorage.setItem('patients', JSON.stringify(patients));
            renderPatients();
            closeAddPatientModal();
            alert('Paziente aggiunto con successo!');
        }

        function closeModal() {
            document.getElementById('patientModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('patientModal');
            const addModal = document.getElementById('addPatientModal');
            if (event.target === modal) closeModal();
            if (event.target === addModal) closeAddPatientModal();
        }

        document.addEventListener('DOMContentLoaded', renderPatients);
    </script>
</body>
</html>