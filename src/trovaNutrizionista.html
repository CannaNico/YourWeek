<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trova Nutrizionista - YourWeek</title>
    <link rel="stylesheet" href="bitnami.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Main Container -->
    <div class="search-page-container">
        <!-- Header -->
        <header class="search-page-header">
            <a href="applications.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
                <span>Torna alla Home</span>
            </a>
            <h1 id="pageTitle" class="search-page-title">Trova Nutrizionista</h1>
            <p id="pageSubtitle" class="search-page-subtitle">Cerca professionisti nella tua provincia</p>
        </header>

        <!-- Search Section -->
        <section class="search-section">
            <div class="search-bar">
                <div class="search-input-group">
                    <label for="provinciaSelect" class="search-label">
                        <i class="fas fa-map-marker-alt"></i>
                        Seleziona Provincia
                    </label>
                    <select id="provinciaSelect" class="provincia-selector">
                        <option value="">-- Seleziona una provincia --</option>
                        <option value="AG">AG - Agrigento</option>
                        <option value="AL">AL - Alessandria</option>
                        <option value="AN">AN - Ancona</option>
                        <option value="AO">AO - Aosta</option>
                        <option value="AR">AR - Arezzo</option>
                        <option value="AP">AP - Ascoli Piceno</option>
                        <option value="AT">AT - Asti</option>
                        <option value="AV">AV - Avellino</option>
                        <option value="BA">BA - Bari</option>
                        <option value="BT">BT - Barletta-Andria-Trani</option>
                        <option value="BL">BL - Belluno</option>
                        <option value="BN">BN - Benevento</option>
                        <option value="BG">BG - Bergamo</option>
                        <option value="BI">BI - Biella</option>
                        <option value="BO">BO - Bologna</option>
                        <option value="BZ">BZ - Bolzano</option>
                        <option value="BS">BS - Brescia</option>
                        <option value="BR">BR - Brindisi</option>
                        <option value="CA">CA - Cagliari</option>
                        <option value="CL">CL - Caltanissetta</option>
                        <option value="CB">CB - Campobasso</option>
                        <option value="CI">CI - Carbonia-Iglesias</option>
                        <option value="CE">CE - Caserta</option>
                        <option value="CT">CT - Catania</option>
                        <option value="CZ">CZ - Catanzaro</option>
                        <option value="CH">CH - Chieti</option>
                        <option value="CO">CO - Como</option>
                        <option value="CS">CS - Cosenza</option>
                        <option value="CR">CR - Cremona</option>
                        <option value="KR">KR - Crotone</option>
                        <option value="CN">CN - Cuneo</option>
                        <option value="EN">EN - Enna</option>
                        <option value="FM">FM - Fermo</option>
                        <option value="FE">FE - Ferrara</option>
                        <option value="FI">FI - Firenze</option>
                        <option value="FG">FG - Foggia</option>
                        <option value="FC">FC - Forlì-Cesena</option>
                        <option value="FR">FR - Frosinone</option>
                        <option value="GE">GE - Genova</option>
                        <option value="GO">GO - Gorizia</option>
                        <option value="GR">GR - Grosseto</option>
                        <option value="IM">IM - Imperia</option>
                        <option value="IS">IS - Isernia</option>
                        <option value="SP">SP - La Spezia</option>
                        <option value="AQ">AQ - L'Aquila</option>
                        <option value="LT">LT - Latina</option>
                        <option value="LE">LE - Lecce</option>
                        <option value="LC">LC - Lecco</option>
                        <option value="LI">LI - Livorno</option>
                        <option value="LO">LO - Lodi</option>
                        <option value="LU">LU - Lucca</option>
                        <option value="MC">MC - Macerata</option>
                        <option value="MN">MN - Mantova</option>
                        <option value="MS">MS - Massa-Carrara</option>
                        <option value="MT">MT - Matera</option>
                        <option value="ME">ME - Messina</option>
                        <option value="MI">MI - Milano</option>
                        <option value="MO">MO - Modena</option>
                        <option value="MB">MB - Monza e Brianza</option>
                        <option value="NA">NA - Napoli</option>
                        <option value="NO">NO - Novara</option>
                        <option value="NU">NU - Nuoro</option>
                        <option value="OT">OT - Olbia-Tempio</option>
                        <option value="OR">OR - Oristano</option>
                        <option value="PD">PD - Padova</option>
                        <option value="PA">PA - Palermo</option>
                        <option value="PR">PR - Parma</option>
                        <option value="PV">PV - Pavia</option>
                        <option value="PG">PG - Perugia</option>
                        <option value="PU">PU - Pesaro e Urbino</option>
                        <option value="PE">PE - Pescara</option>
                        <option value="PC">PC - Piacenza</option>
                        <option value="PI">PI - Pisa</option>
                        <option value="PT">PT - Pistoia</option>
                        <option value="PN">PN - Pordenone</option>
                        <option value="PZ">PZ - Potenza</option>
                        <option value="PO">PO - Prato</option>
                        <option value="RG">RG - Ragusa</option>
                        <option value="RA">RA - Ravenna</option>
                        <option value="RC">RC - Reggio Calabria</option>
                        <option value="RE">RE - Reggio Emilia</option>
                        <option value="RI">RI - Rieti</option>
                        <option value="RN">RN - Rimini</option>
                        <option value="RM">RM - Roma</option>
                        <option value="RO">RO - Rovigo</option>
                        <option value="SA">SA - Salerno</option>
                        <option value="VS">VS - Medio Campidano</option>
                        <option value="SS">SS - Sassari</option>
                        <option value="SV">SV - Savona</option>
                        <option value="SI">SI - Siena</option>
                        <option value="SR">SR - Siracusa</option>
                        <option value="SO">SO - Sondrio</option>
                        <option value="TA">TA - Taranto</option>
                        <option value="TE">TE - Teramo</option>
                        <option value="TR">TR - Terni</option>
                        <option value="TO">TO - Torino</option>
                        <option value="OG">OG - Ogliastra</option>
                        <option value="TP">TP - Trapani</option>
                        <option value="TN">TN - Trento</option>
                        <option value="TV">TV - Treviso</option>
                        <option value="TS">TS - Trieste</option>
                        <option value="UD">UD - Udine</option>
                        <option value="VA">VA - Varese</option>
                        <option value="VE">VE - Venezia</option>
                        <option value="VB">VB - Verbano-Cusio-Ossola</option>
                        <option value="VC">VC - Vercelli</option>
                        <option value="VR">VR - Verona</option>
                        <option value="VV">VV - Vibo Valentia</option>
                        <option value="VI">VI - Vicenza</option>
                        <option value="VT">VT - Viterbo</option>
                    </select>
                </div>
                <button id="searchButton" class="search-button">
                    <i class="fas fa-search"></i>
                    <span>Cerca</span>
                </button>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section">
            <div id="resultsContainer" class="results-container">
                <!-- Results will be dynamically inserted here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-search"></i>
                <h3>Nessun risultato trovato</h3>
                <p>Prova a selezionare un'altra provincia</p>
            </div>

            <!-- Initial State -->
            <div id="initialState" class="initial-state">
                <i class="fas fa-map-marked-alt"></i>
                <h3>Seleziona una provincia per iniziare</h3>
                <p>Scegli la tua provincia dal menu a tendina e clicca su "Cerca"</p>
            </div>
        </section>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let searchRole = null; // 'nutrizionista' or 'paziente'

        // Check authentication on page load
        async function checkAuthentication() {
            try {
                const response = await fetch('../api/auth.php?action=check_session', {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (!result.success || !result.user) {
                    // Not authenticated, redirect to login
                    window.location.href = 'loginPage.html';
                    return false;
                }

                currentUser = result.user;
                updateUIForRole();
                return true;
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = 'loginPage.html';
                return false;
            }
        }

        // Update UI based on user role
        function updateUIForRole() {
            const pageTitle = document.getElementById('pageTitle');
            const pageSubtitle = document.getElementById('pageSubtitle');

            if (currentUser.role === 'paziente') {
                // Patient searches for nutritionists
                searchRole = 'nutrizionista';
                pageTitle.textContent = 'Trova Nutrizionista';
                pageSubtitle.textContent = 'Cerca nutrizionisti professionisti nella tua provincia';
            } else if (currentUser.role === 'nutrizionista') {
                // Nutritionist searches for patients/clients
                searchRole = 'paziente';
                pageTitle.textContent = 'Trova Clienti';
                pageSubtitle.textContent = 'Cerca potenziali clienti nella tua provincia';
            }
        }

        // Search users by province
        async function searchUsers() {
            const provinciaSelect = document.getElementById('provinciaSelect');
            const provincia = provinciaSelect.value;

            if (!provincia) {
                alert('Seleziona una provincia');
                return;
            }

            // Show loading
            showLoading(true);
            hideAllStates();

            try {
                const response = await fetch(`../api/search_users.php?provincia=${provincia}&role=${searchRole}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    displayResults(result.users);
                } else {
                    console.error('Search failed:', result.error);
                    alert('Errore durante la ricerca: ' + result.error);
                    showInitialState();
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Errore di connessione. Riprova più tardi.');
                showInitialState();
            } finally {
                showLoading(false);
            }
        }

        // Display search results
        function displayResults(users) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';

            if (users.length === 0) {
                showEmptyState();
                return;
            }

            users.forEach(user => {
                const card = createUserCard(user);
                resultsContainer.appendChild(card);
            });

            showResults();
        }

        // Create user card element
        function createUserCard(user) {
            const card = document.createElement('div');
            card.className = 'user-card';

            const roleIcon = user.role === 'nutrizionista'
                ? '<i class="fas fa-user-md"></i>'
                : '<i class="fas fa-user"></i>';

            const roleLabel = user.role === 'nutrizionista' ? 'Nutrizionista' : 'Cliente';
            const description = user.description || 'Nessuna descrizione disponibile';

            card.innerHTML = `
                <div class="user-card-header">
                    <div class="user-avatar">
                        ${roleIcon}
                    </div>
                    <div class="user-info">
                        <h3 class="user-name">${user.first_name} ${user.last_name}</h3>
                        <span class="user-role">${roleLabel}</span>
                    </div>
                </div>
                <div class="user-card-body">
                    <div class="user-detail">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${user.provincia_full || user.provincia}</span>
                    </div>
                    <p class="user-description">${description}</p>
                </div>
                <div class="user-card-footer">
                    <button class="contact-button" onclick="contactUser(${user.id})">
                        <i class="fas fa-envelope"></i>
                        Contatta
                    </button>
                    <button class="profile-button" onclick="viewProfile(${user.id})">
                        <i class="fas fa-eye"></i>
                        Visualizza Profilo
                    </button>
                </div>
            `;

            return card;
        }

        // Contact user (placeholder)
        function contactUser(userId) {
            alert(`Funzionalità di contatto per utente ID: ${userId} in sviluppo`);
            // TODO: Implement messaging functionality
        }

        // View profile (placeholder)
        function viewProfile(userId) {
            alert(`Visualizzazione profilo utente ID: ${userId} in sviluppo`);
            // TODO: Implement profile view
        }

        // UI state management
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        function hideAllStates() {
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('initialState').style.display = 'none';
        }

        function showResults() {
            hideAllStates();
            document.getElementById('resultsContainer').style.display = 'grid';
        }

        function showEmptyState() {
            hideAllStates();
            document.getElementById('emptyState').style.display = 'flex';
        }

        function showInitialState() {
            hideAllStates();
            document.getElementById('initialState').style.display = 'flex';
        }

        // Event listeners
        document.getElementById('searchButton').addEventListener('click', searchUsers);

        // Allow Enter key to search
        document.getElementById('provinciaSelect').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });

        // Initialize page
        window.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuthentication();
            if (isAuthenticated) {
                showLoading(false);
            }
        });
    </script>
</body>

</html>